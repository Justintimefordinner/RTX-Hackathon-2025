<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Chat + Flights</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .chat-box {height: 50vh; overflow-y: auto; border: 1px solid #ddd; border-radius: .5rem; padding: .75rem;}
    .msg {margin-bottom: .5rem;}
    .msg small {color: #6c757d;}
  </style>
</head>
<body class="bg-light">
<div class="container py-4">

  <nav class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">Secure Link</h1>
    {% if current_user.is_authenticated %}
      <div class="d-flex align-items-center gap-3">
        <span class="text-muted">Signed in as <strong>{{ current_user.username }}</strong></span>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('logout') }}">Logout</a>
      </div>
    {% endif %}
  </nav>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="alert alert-warning py-2">{{ messages|join(", ") }}</div>
    {% endif %}
  {% endwith %}

  {% if not current_user.is_authenticated %}
    <!-- Login/Register Section -->
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <ul class="nav nav-pills mb-3" id="authTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login" type="button" role="tab">Login</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button" role="tab">Register</button>
              </li>
            </ul>

            <div class="tab-content">
              <div class="tab-pane fade show active" id="login" role="tabpanel">
                <form method="post" action="{{ url_for('login') }}" class="row g-2">
                  <div class="col-12"><input name="username" class="form-control" placeholder="Username" required></div>
                  <div class="col-12"><input name="password" type="password" class="form-control" placeholder="Password" required></div>
                  <div class="col-12 d-grid"><button class="btn btn-primary">Login</button></div>
                </form>
              </div>

              <div class="tab-pane fade" id="register" role="tabpanel">
                <form method="post" action="{{ url_for('register') }}" class="row g-2">
                  <div class="col-12"><input name="username" class="form-control" placeholder="Choose a username" required></div>
                  <div class="col-12"><input name="password" type="password" class="form-control" placeholder="Choose a password" required></div>
                  <div class="col-12 d-grid"><button class="btn btn-success">Create account</button></div>
                </form>
              </div>
            </div>

            <p class="text-muted mt-3 mb-0 small">You must be signed in to use chat and flight viewer.</p>
          </div>
        </div>
      </div>
    </div>

  {% else %}
    <!-- Main app tabs -->
    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
      <li class="nav-item"><button class="nav-link" id="flights-tab" data-bs-toggle="tab" data-bs-target="#flights" type="button" role="tab">Flight Viewer</button></li>
      <li class="nav-item"><button class="nav-link" id="section2-tab" data-bs-toggle="tab" data-bs-target="#section2" type="button" role="tab">North Carolina Flight Search</button></li>
      <li class="nav-item"><button class="nav-link active" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button" role="tab">Messaging</button></li>
    </ul>

    <div class="tab-content border-start border-end border-bottom p-3 bg-white rounded-bottom" id="mainTabsContent">
      <!-- Chat -->
      <div class="tab-pane fade show active" id="chat" role="tabpanel">
        <div class="row g-3">
          <div class="col-12"><div id="chatBox" class="chat-box"></div></div>
          <div class="col-md-3"><input id="userInput" class="form-control" value="{{ current_user.username }}" readonly></div>
          <div class="col-md-7"><input id="textInput" class="form-control" placeholder="Type a message and hit Enter"></div>
          <div class="col-md-2 d-grid"><button id="sendBtn" class="btn btn-primary">Send</button></div>
        </div>
      </div>

      <!-- SECTION 2 (NC Airport Dropdown + Flights) -->
      <div class="tab-pane fade" id="section2" role="tabpanel" aria-labelledby="section2-tab">
        <h5 class="mb-3">North Carolina Airports</h5>

        <div class="mb-3">
          <select id="airportSelect" class="form-select">
            <option value="">Select an NC airport...</option>
          </select>
        </div>

        <div id="selectedAirport" class="alert alert-secondary" style="display:none;"></div>

        <div id="airportFlights" style="display:none;">
          <h6>Flights for selected airport</h6>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr><th>Flight</th><th>From</th><th>To</th><th>Departs</th><th>Arrives</th></tr>
              </thead>
              <tbody id="airportFlightsBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Iowa Flight Viewer -->
      <div class="tab-pane fade" id="flights" role="tabpanel" aria-labelledby="flights-tab">
        <div class="d-flex justify-content-between align-items-center mb-2 mt-2">
          <h5 class="mb-0">Flights</h5>
          <button id="refreshFlights" class="btn btn-outline-secondary btn-sm">Refresh</button>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead><tr><th>Flight</th><th>From</th><th>To</th><th>Departs</th><th>Arrives</th></tr></thead>
            <tbody id="flightsBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      // --- Chat logic ---
      let lastTs = null;
      const chatBox = document.getElementById("chatBox");
      const textInput = document.getElementById("textInput");
      const sendBtn  = document.getElementById("sendBtn");
      const flightsBody = document.getElementById("flightsBody");
      const refreshFlights = document.getElementById("refreshFlights");

      function renderMsg(m){
        const div = document.createElement("div");
        div.className = "msg";
        const time = new Date(m.ts).toLocaleTimeString();
        div.innerHTML = `<strong>${escapeHtml(m.user)}</strong>: ${escapeHtml(m.text)} <br><small>${time}</small>`;
        chatBox.appendChild(div);
      }
      function escapeHtml(s){return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

      async function loadMessages(){
        const url = lastTs?`/api/messages?since=${encodeURIComponent(lastTs)}`:"/api/messages";
        const res = await fetch(url);
        if(!res.ok)return;
        const data = await res.json();
        if(data.length){
          data.forEach(renderMsg);
          chatBox.scrollTop = chatBox.scrollHeight;
          lastTs = data[data.length-1].ts;
        }
      }

      async function sendMessage(){
        const text=textInput.value.trim();
        if(!text)return;
        await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text})});
        textInput.value="";
        await loadMessages();
      }

      sendBtn?.addEventListener("click",sendMessage);
      textInput?.addEventListener("keydown",e=>{if(e.key==="Enter")sendMessage();});
      setInterval(loadMessages,2000);
      loadMessages();

      // --- Flight Viewer logic ---
      async function loadFlights(){
        const res=await fetch("/services/flight_api");
        if(!res.ok)return;
        const data=await res.json();
        flightsBody.innerHTML=data.map(f=>`
          <tr>
            <td>${escapeHtml(f.flight)}</td>
            <td>${escapeHtml(f.from)}</td>
            <td>${escapeHtml(f.to)}</td>
            <td>${new Date(f.dep).toLocaleString()}</td>
            <td>${new Date(f.arr).toLocaleString()}</td>
          </tr>`).join("");
      }
      refreshFlights?.addEventListener("click",loadFlights);
      document.getElementById("flights-tab")?.addEventListener("shown.bs.tab",loadFlights);

      // --- NC Airport Dropdown logic ---
      const airportSelect = document.getElementById("airportSelect");
      const selectedAirportDiv = document.getElementById("selectedAirport");
      const airportFlightsDiv = document.getElementById("airportFlights");
      const airportFlightsBody = document.getElementById("airportFlightsBody");

      async function loadAirports(){
        const res = await fetch("/api/airports");
        if(!res.ok)return;
        const airports = await res.json();
        airportSelect.innerHTML = '<option value="">Select an NC airport...</option>' +
          airports.map(a => `<option value="${a.code}">${a.name} (${a.code})</option>`).join("");
      }

      async function loadAirportFlights(code){
        const res = await fetch(`/api/flights?airport=${encodeURIComponent(code)}`);
        if(!res.ok)return;
        const flights = await res.json();
        if(flights.length === 0){
          airportFlightsBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No flights found for this airport</td></tr>`;
        } else {
          airportFlightsBody.innerHTML = flights.map(f=>`
            <tr>
              <td>${escapeHtml(f.flight)}</td>
              <td>${escapeHtml(f.from)}</td>
              <td>${escapeHtml(f.to)}</td>
              <td>${new Date(f.dep).toLocaleString()}</td>
              <td>${new Date(f.arr).toLocaleString()}</td>
            </tr>`).join("");
        }
        airportFlightsDiv.style.display = "block";
      }

      airportSelect.addEventListener("change", async () => {
        const selectedCode = airportSelect.value;
        const selectedText = airportSelect.options[airportSelect.selectedIndex].text;
        if(selectedCode){
          selectedAirportDiv.textContent = `You selected: ${selectedText}`;
          selectedAirportDiv.style.display = "block";
          await loadAirportFlights(selectedCode);
        } else {
          selectedAirportDiv.style.display = "none";
          airportFlightsDiv.style.display = "none";
        }
      });

      document.getElementById("section2-tab")?.addEventListener("shown.bs.tab", loadAirports);
    </script>
  {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
